{% extends 'base.html' %}
{% block content %}
<style>
/* === GLOBAL BACKGROUND === */
body {
  margin: 0;
  padding: 0;
  background: radial-gradient(circle at 25% 25%, #001f3f, #000814);
  min-height: 100vh;
  font-family: 'Poppins', sans-serif;
  color: #fff;
  overflow-x: hidden;
  position: relative;
}

/* Sparkle Animation on background */
body::before, body::after {
  content: '';
  position: absolute;
  width: 600px;
  height: 600px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(0, 204, 255, 0.25), transparent 70%);
  filter: blur(200px);
  animation: floaty 18s ease-in-out infinite alternate;
}
body::before {
  top: -200px;
  left: -150px;
}
body::after {
  bottom: -250px;
  right: -200px;
}
@keyframes floaty {
  from { transform: translateY(0px) rotate(0deg); }
  to { transform: translateY(-60px) rotate(15deg); }
}

/* === CONTAINER === */
.container {
  max-width: 1100px;
  margin: 60px auto;
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 25px;
  z-index: 2;
  position: relative;
}

/* === 3D Card with Blue-Black Polish === */
.card {
  background: linear-gradient(145deg, rgba(10, 30, 60, 0.95), rgba(0, 0, 0, 0.7));
  border: 1px solid rgba(0, 153, 255, 0.25);
  border-radius: 16px;
  padding: 20px;
  box-shadow:
    0 0 12px rgba(0, 153, 255, 0.3),
    inset 0 0 8px rgba(255, 255, 255, 0.08),
    0 4px 20px rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(12px);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 0 20px rgba(0, 153, 255, 0.4);
}

/* === HEADINGS === */
.card h3, .card h4, .card h5 {
  color: #00bfff;
  margin-top: 0;
  text-shadow: 0 0 6px rgba(0, 191, 255, 0.6);
}

/* === DETAILS STYLE === */
.small {
  font-size: 0.9rem;
  color: #bcd3ff;
  letter-spacing: 0.3px;
}

/* === BUTTONS === */
.btn, .btn-danger {
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.3s ease;
  color: white;
  box-shadow: 0 0 8px rgba(0,0,0,0.3);
}
.btn {
  background: linear-gradient(135deg, #007bff, #00d4ff);
}
.btn:hover {
  background: linear-gradient(135deg, #00a6ff, #00ffff);
  transform: translateY(-2px);
}
.btn-danger {
  background: linear-gradient(135deg, #ff0033, #ff4b2b);
}
.btn-danger:hover {
  background: linear-gradient(135deg, #ff3344, #ff6666);
  transform: translateY(-2px);
}

/* === FILE UPLOAD ROW === */
.upload-row {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}
input[type="file"] {
  color: #fff;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  padding: 6px;
}

/* === PROGRESS BAR === */
.progress {
  width: 100%;
  height: 8px;
  border-radius: 4px;
  overflow: hidden;
  background: rgba(255,255,255,0.1);
}
.progress::-webkit-progress-bar {
  background: rgba(255,255,255,0.1);
}
.progress::-webkit-progress-value {
  background: linear-gradient(90deg, #00bfff, #00ffff);
}

/* === PARTICIPANTS BOX === */
.participant-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.participant-item {
  background: rgba(0, 102, 204, 0.08);
  border-radius: 6px;
  padding: 8px 10px;
  margin-bottom: 6px;
  transition: 0.2s;
}
.participant-item:hover {
  background: rgba(0, 204, 255, 0.18);
}

/* === FILE LIST === */
#file-list li {
  margin-bottom: 8px;
  color: #b8e3ff;
}

/* === SPARK EFFECT on hover === */
.card:hover::after {
  content: '';
  position: absolute;
  width: 80px;
  height: 80px;
  background: radial-gradient(circle, rgba(0,191,255,0.4), transparent 60%);
  top: 0;
  right: 0;
  filter: blur(30px);
  animation: sparkle 3s ease-in-out infinite alternate;
}
@keyframes sparkle {
  from { opacity: 0.3; transform: translate(0, 0); }
  to { opacity: 0.8; transform: translate(-15px, 15px); }
}
</style>

<div class="container">
  <!-- === LEFT SIDE: SESSION + FILES === -->
  <div class="card">
    <h3>Session: <span id="session-token">{{ token }}</span></h3>
    <p class="small">Owner: {{ owner_name }}</p>

    <div style="margin-top:12px;">
      <h4>Upload File</h4>
      <div class="upload-row">
        <input type="file" id="file-input">
        <button id="upload-btn" class="btn">Upload</button>
      </div>
      <div id="progress-wrap" style="display:none; margin-top:8px;">
        <progress id="upload-progress" class="progress" value="0" max="100"></progress>
        <div id="progress-text" class="small"></div>
      </div>
    </div>

    <div style="margin-top:20px;">
      <h4>Files</h4>
      <ul id="file-list">
        {% for f in files %}
          <li>{{ f }} — <a href="{{ url_for('online_transfer.download_file', token=token, filename=f) }}" style="color:#00eaff;">Download</a></li>
        {% else %}
          <li class="small">No files yet.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- === RIGHT SIDE: PARTICIPANTS + CONTROLS === -->
  <div class="card">
    <h4>Participants (<span id="pcount">{{ participants|length }}</span>)</h4>
    <ul id="participants" class="participant-list">
      {% for p in participants %}
        <li class="participant-item">{{ p }}</li>
      {% endfor %}
    </ul>

    <div style="margin-top:16px;">
      {% if is_owner %}
      <h5>Session Controls</h5>
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="end-btn" class="btn-danger">End Session</button>
        <button id="set-timeout" class="btn">Set Auto Timeout</button>
      </div>
      <div id="timeout-box" style="display:none; margin-top:8px;">
        <label>Auto-expire (minutes)</label>
        <input id="timeout-min" type="number" min="1" placeholder="e.g. 60" style="border-radius:6px; padding:4px; border:none;">
        <button id="apply-timeout" class="btn">Apply</button>
      </div>
      {% else %}
      <p class="small">You are connected as a receiver. The sender controls this session.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- JS (unchanged logic) -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const token = "{{ token }}";
const socket = io();

socket.emit('join_room', {token: token, user: "{{ current_user.username }}"});

socket.on('participants_update', data => {
  const list = document.getElementById('participants');
  list.innerHTML = '';
  data.participants.forEach(p => {
    const li = document.createElement('li');
    li.className = 'participant-item';
    li.textContent = p;
    list.appendChild(li);
  });
  document.getElementById('pcount').textContent = data.participants.length;
});

socket.on('file_added', d => {
  const ul = document.getElementById('file-list');
  const li = document.createElement('li');
  li.innerHTML = d.filename + ' — <a href="/online/download/'+token+'/'+encodeURIComponent(d.filename)+'" style="color:#00eaff;">Download</a>';
  ul.appendChild(li);
});

socket.on('session_ended', () => {
  alert('Session ended by owner or expired.');
  window.location = "{{ url_for('online_transfer.select_mode') }}";
});

socket.on('auto_expire_set', data => {
  alert('Auto timeout set for ' + data.minutes + ' minutes');
});

document.getElementById('upload-btn').addEventListener('click', () => {
  const f = document.getElementById('file-input').files[0];
  if(!f) return alert('Choose a file');
  const xhr = new XMLHttpRequest();
  const fd = new FormData();
  fd.append('file', f);
  xhr.open('POST', `/online/upload/${token}`, true);
  xhr.upload.onprogress = function(e) {
    if(e.lengthComputable) {
      const pct = Math.round((e.loaded / e.total) * 100);
      document.getElementById('progress-wrap').style.display = 'block';
      document.getElementById('upload-progress').value = pct;
      document.getElementById('progress-text').textContent = pct + '%';
    }
  };
  xhr.onload = function() {
    if(xhr.status === 200) {
      alert('Upload complete');
      document.getElementById('progress-wrap').style.display = 'none';
    } else {
      alert('Upload failed');
    }
  };
  xhr.send(fd);
});

const endBtn = document.getElementById('end-btn');
if(endBtn) endBtn.addEventListener('click', async () => {
  if(!confirm('End session and delete files?')) return;
  const res = await fetch('/online/end/' + token, {method:'POST'});
  const js = await res.json();
  if(js.status === 'ended') window.location = "{{ url_for('online_transfer.select_mode') }}";
  else alert('Could not end session');
});

const st = document.getElementById('set-timeout');
if(st) st.addEventListener('click', ()=> {
  document.getElementById('timeout-box').style.display = 'block';
});
const apply = document.getElementById('apply-timeout');
if(apply) apply.addEventListener('click', async () => {
  const mins = document.getElementById('timeout-min').value;
  if(!mins) return alert('Enter minutes');
  const fd = new FormData();
  fd.append('minutes', mins);
  const res = await fetch('/online/set_auto_expire/' + token, {method:'POST', body:fd});
  const js = await res.json();
  if(js.status === 'ok') alert('Auto timeout set');
  else alert('Could not set timeout');
});
</script>
{% endblock %}
